
. ./env.sh

if [ -z "${MYHOME}" ]; then
    echo "This script must be started by apptainer"
    echo "  ./2-initial-submitter"
    exit 1
fi

echo I am in a container:
env|grep APPTAINER
lsb_release -a

id=genlauncher-${SLURM_JOBID-deleteme}

# creating scripts for some number of complex tasks

for task_number in 1 2; do

    echo I am complex task ${task_number}
    
    # Plan something here (using OpenGL/EGL like with pyBullet)
    #./do-something-useful > ${header}-${id}-${task_number}
    
    # The following file ${header}-${id}-${task_number}
    # is supposed to be generated by the "./do-something-useful" above

#####################################
    # generate slurm sbatch file
    cat << EOF > ${header}-${id}-${task_number}

echo I am a fake complex task called ${header}-${id}-${task_number}
echo I am generated at date $(date) and started at date \$(date)
echo I am running on host \$(hostname)
echo and I should be runned from inside a container
nvidia-smi
env | grep APPTAINER

EOF
    chmod +x ${header}-${id}-${task_number}
#####################################

    # The following file is the slurm+container launcher for the above file

#####################################
    # generate slurm sbatch file
    cat << EOF > ${header}-${id}-${task_number}.sbatch
#!/bin/bash
#SBATCH --job-name=fakeGeneratedTask-${task_number}
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --partition=gpu
#SBATCH --mail-type=ALL
#SBATCH --output=stdout-%j.txt
#SBATCH --error=stderr-%j.txt
#SBATCH --mem=5G
#SBATCH --gres=gpu:1

../__gputainer/runvnc $(pwd)/${header}-${id}-${task_number}
EOF
#####################################

done
