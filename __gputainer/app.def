Bootstrap: docker
From: ubuntu:20.04

%setup
    mkdir ${APPTAINER_ROOTFS}/local
    mkdir ${APPTAINER_ROOTFS}/pyenv
    mkdir ${APPTAINER_ROOTFS}/hostpwd
    mkdir ${APPTAINER_ROOTFS}/net
    ln -s /net/pfcalcul/pfcalcul ${APPTAINER_ROOTFS}/pfcalcul

# copy these local files into container
%files
    ${APPTAINER_APPDIR}/../user-preinstall /user-preinstall
    ${APPTAINER_APPDIR}/../user-postinstall /user-postinstall
    ${APPTAINER_APPDIR}/../run-in-container /run-in-container
    debs/virtualgl_3.0.1_amd64.deb
    debs/cudnn-local-repo-ubuntu2004-8.4.0.27_1.0-1_amd64.deb

# build commands
%post

    ###################################################
    ###### check if %environment must be updated ######
    export ROOT=/pyenv
    export FAST="--override-channels -c main -c conda-forge"
    export PREFIX1=${ROOT}/conda
    export PREFIX2=${ROOT}/app
    export PATH=${PREFIX2}/bin:${PREFIX1}/bin:${PATH}
    export DEBIAN_FRONTEND=noninteractive

    ###################################################
    apt -y update

    if [ -x /user-preinstall ]; then
        /user-preinstall
    else
        echo "(no executable 'user-preinstall' script found)"
    fi

    ###################################################
    # ubuntu nvidia GL drivers
    # https://docs.nvidia.com/deploy/cuda-compatibility/index.html#use-the-right-compat-package
    echo "Installing user packages: ${NVIDIA_PKG}"
    [ -z "${NVIDIA_PKG}" ] || apt -y install ${NVIDIA_PKG}

    # X/GL and download general dependencies
    # windows manager: icewm
    apt -y install git wget curl xterm x11-apps mesa-utils liburdfdom-model libglib2.0-0 icewm

    # local debian packages not available in repos
    #debs="debs/virtualgl_3.0.1_amd64.deb debs/cudnn-local-repo-ubuntu2004-8.4.0.27_1.0-1_amd64.deb"
    debs="debs/*.deb"
    dpkg -i ${debs} || apt -y -f install
    rm -f ${debs}

    # cudnn pkgs from debs/cudnn-local-repo-ubuntu*deb:
    #dpkg -i /var/cudnn-local*/*deb || apt -y -f install
    dpkg -i /var/cudnn-local*/libcudnn8_*.deb || apt -y -f install

    rm -f /var/cudnn-local*/*deb

    ###################################################
    # python needs compiler suite
    #apt -y install build-essential sudo git # gdb
    # debug
    #apt -y install glmark2 glmark2-es2 #debug

    ###################################################
    # python environment

    mkdir -p ${ROOT}
    cd ${ROOT}

    if [ -r /hostpwd/${APPNAME}/environment.yaml ]; then

        if [ ! -d ${PREFIX1} ]; then
            [ -r Miniconda3-latest-Linux-x86_64.sh ] || wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
            bash Miniconda3-latest-Linux-x86_64.sh -b -p ${PREFIX1}
        fi
        if [ ! -d ${PREFIX2} ]; then
            conda env create --file /hostpwd/${APPNAME}/environment.yaml --prefix ${PREFIX2}
        fi
        # update .bashrc:
        conda init bash

        # build application
        ## ubuntu runs dash incompatible with "shopt" command run in conda init script so .bashrc cannot be sourced
        ## also PS1 must be set to something or .bashrc's first line will discard the whole script
        bash -c "PS1=blah; . ${HOME}/.bashrc; conda activate ${PREFIX2}; export PATH=${PREFIX2}/bin:${PATH}; cd /hostpwd/${APPNAME}; python3 setup.py install; /user-postinstall"

    elif [ -r /hostpwd/${APPNAME}/requirements.txt ]; then

        apt -y install python3 python3-venv
        [ -d venv ] || python3 -m venv ${ROOT}/venv
        . ${ROOT}/venv/bin/activate
        pip install -r /hostpwd/${APPNAME}/requirements.txt

        cd /hostpwd/${APPNAME}
        /user-postinstall

    else

        echo "================================================================"
        echo "NO PYTHON INSTALLER FOUND (environment.yaml or requirements.txt)"
        echo "================================================================"
        sleep 5

        cd /hostpwd/${APPNAME}
        /user-postinstall

    fi


##### TEST

# environment at runtime
%environment
    export ROOT=/pyenv
    export FAST="--override-channels -c main -c conda-forge"
    export PREFIX1=${ROOT}/conda
    export PREFIX2=${ROOT}/app
    export PATH=${PREFIX2}/bin:${PREFIX1}/bin:${PATH}
    export DEBIAN_FRONTEND=noninteractive


%runscript
    /run-in-container

#%startscript
#    /run-in-container
