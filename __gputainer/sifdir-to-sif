#!/bin/bash

set -e
mkdir transportable

APPNAME=${PWD##*/}

sifdir=`cd generated; echo ${APPNAME}.sifdir`
if [ ! -d "generated/${sifdir}/." ]; then
    echo "generated/${sifdir}/ is not existing!"
    exit 1
fi

# vnc runner is the entry point
cp ../__gputainer/runvnc transportable/${APPNAME}.runme
chmod +x transportable/${APPNAME}.runme

# duplicate runner in container
cp run-in-container transportable/

# temporarily move pyenv/ content to sifdir
# in order to build a self-contained sif container
mkdir -p generated/${sifdir}/pyenv/
trap 'mv generated/${sifdir}/pyenv/* generated/PYTHAINER/' EXIT
mv generated/PYTHAINER/* generated/${sifdir}/pyenv/

# build the sif container image
sif=${sifdir%*dir}
apptainer build transportable/${sif} generated/${sifdir}
chmod -x transportable/${sif}
